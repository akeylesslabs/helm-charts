{{- if ( and .Values.cache .Values.cache.tls .Values.cache.tls.autoGenerated) }}
{{- $fullname := .Release.Name | trunc 63 | trimSuffix "-" -}}
{{- $ca := genCA "redis-ca" 365 }}
{{- $altNames := list $fullname "127.0.0.1" "localhost" (include "cache_address" .) (printf "*.%s" (include "cache_address" . ))}}
{{- $cert := genSignedCert $fullname nil $altNames 365 $ca }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace (include "generated_cache_tls_secret_name" .)).data }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "generated_cache_tls_secret_name" . }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    name: {{ include "generated_cache_tls_secret_name" . }}
    component: cache
{{- include "akeyless-api-gw.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  tls.crt: {{ get $existingSecret "tls.crt" | default ($cert.Cert | b64enc) }}
  tls.key: {{ get $existingSecret "tls.key" | default ($cert.Key | b64enc) }}
  ca.crt: {{ get $existingSecret "ca.crt" | default ($ca.Cert | b64enc) }}

{{- end }}